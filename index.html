<!doctype html>
<meta charset="utf-8">
<title>ESP32 Dual-Region Flasher</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,sans-serif;max-width:700px;margin:24px auto}
  .row{margin:10px 0;display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  button{padding:8px 14px;border:1px solid #ccc;border-radius:8px;background:#f0f0f0;cursor:pointer}
  button:disabled{opacity:.5;cursor:not-allowed}
  progress{width:250px;height:14px}
  pre{background:#111;color:#eee;padding:10px;border-radius:6px;height:200px;overflow:auto;font-family:monospace}
</style>

<h1>ESP32 Dual-Region Flasher</h1>
<p>Writes your chosen <code>.bin</code> to <b>0x20000</b> and <b>0x1C0000</b>. (Chrome/Edge only.)</p>

<div class="row">
  <input type="file" id="fw" accept=".bin">
  <select id="baud"><option>921600</option><option selected>115200</option></select>
  <button id="connect">Connect</button>
  <button id="flash" disabled>Flash</button>
  <button id="disconnect" disabled>Disconnect</button>
</div>

<div class="row">
  <progress id="prog" max="100" value="0"></progress>
  <span id="pct">0%</span>
</div>

<pre id="log">Load this on GitHub Pages over HTTPS in Chrome/Edge.</pre>

<!-- IMPORTANT: relative path; both files live in the same folder -->
<script src="./esptooljs.bundle.js?v=2"></script>
<script>
const $=id=>document.getElementById(id),logEl=$("log");
const log=m=>{logEl.textContent+=(logEl.textContent?"\n":"")+m;logEl.scrollTop=logEl.scrollHeight;}
const OFFSETS=[0x20000,0x1C0000];
let loader,transport;

const T=window.TransportWebSerial||window.WebSerialTransport||window.Transport;
if(!window.ESPLoader||!T){log("ERROR: bundle missing globals.");throw new Error("Bad bundle");}

$("fw").onchange=()=>{$("flash").disabled=!(transport&&$("fw").files[0]);};

$("connect").onclick=async()=>{
  try{
    if(!("serial" in navigator)) throw new Error("Use Chrome/Edge over HTTPS.");
    const port=await navigator.serial.requestPort({});
    const baud=parseInt($("baud").value,10);
    transport=(T.length>=1)?new T(port):new T();
    if(transport.connect) await transport.connect(baud);
    loader=new ESPLoader({transport,baudrate:baud,terminal:{write:log,writeLine:log}});
    logEl.textContent="Connecting...";
    if(loader.initialize) await loader.initialize(); else { await loader.connect?.(); await loader.sync?.(); await loader.flush?.(); }
    log("Connected to "+(await loader.chipName?.()||"ESP32"));
    $("connect").disabled=true;$("disconnect").disabled=false;
    $("flash").disabled=!(!$("fw").files.length);
  }catch(e){log("Connect error: "+(e?.message||e));}
};

$("disconnect").onclick=async()=>{try{await transport?.disconnect?.()}catch{} transport=null;loader=null;
  $("connect").disabled=false;$("disconnect").disabled=true;$("flash").disabled=true;};

$("flash").onclick=async()=>{
  try{
    const file=$("fw").files[0]; if(!file) return alert("Select .bin");
    const data=new Uint8Array(await file.arrayBuffer());
    const jobs=OFFSETS.map(addr=>({data,address:addr}));
    $("prog").value=0;$("pct").textContent="0%"; log(`Flashing ${file.name} to 0x20000 and 0x1C0000…`);
    const prog=p=>{ if(Number.isFinite(p)){ $("prog").value=p; $("pct").textContent=p.toFixed(1)+"%"; } };
    if(loader.flash) await loader.flash(jobs,prog);
    else if(loader.flashIdfData) await loader.flashIdfData(jobs,prog);
    else{
      const arr=jobs.map(j=>({address:j.address,data:loader.ui8ToBstr(j.data)}));
      await loader.writeFlash({fileArray:arr,flashSize:"keep",flashMode:"keep",flashFreq:"keep",eraseAll:false,compress:true,
        reportProgress:(_,w,t)=>{ const p=t?(w/t)*100:0; prog(p); }});
    }
    log("Done. Resetting…"); await loader.hardReset?.(); log("Complete.");
  }catch(e){log("Flash error: "+(e?.message||e));}
};
</script>
