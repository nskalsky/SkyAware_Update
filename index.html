<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ESP Tool (based on esptool-js)</title>

<!-- Pull the official bundle -->
<script src="https://unpkg.com/esptool-js/bundle.js"></script>

<h1>ESP Tool</h1>
<button id="connect">Connect</button>
<button id="program" disabled>Program</button>
<pre id="log"></pre>

<script>
  const log = (m)=>{ const el=document.getElementById('log'); el.textContent+=m+"\\n"; el.scrollTop=el.scrollHeight; };

  let loader, port;

  document.getElementById('connect').onclick = async () => {
    try {
      port = await navigator.serial.requestPort();                 // user picks device
      await port.open({ baudRate: 115200 });
      loader = new window.ESPLoader({ transport: { device: port }, baudrate: 115200, terminal: { write: log, writeLine: log }});
      await loader.connect('default_reset', 7, true);              // same connect flow as the demo
      await loader.runStub();
      try { await loader.changeBaud(921600); } catch(e) {}
      document.getElementById('program').disabled = false;
      log('Connected: ' + await loader.chipName());
    } catch (e) {
      log('Connect failed: ' + e);
    }
  };

  // Minimal “program one file” example — customize later
  document.getElementById('program').onclick = async () => {
    try {
      const [fh] = await window.showOpenFilePicker({ types: [{ description:'Firmware', accept:{'application/octet-stream':['.bin']}}]});
      const u8 = new Uint8Array(await (await fh.getFile()).arrayBuffer());

      const offset = 0x20000;  // set your default here or make inputs
      const blocks = await loader.flashDeflBegin(u8.length, u8.length, offset);
      const bs = loader.FLASH_WRITE_SIZE || 0x400;
      for (let i=0;i<blocks;i++){
        await loader.flashDeflBlock(u8.subarray(i*bs, (i+1)*bs), i, 5000);
      }
      await loader.flashDeflFinish(false);
      await loader.after('hard_reset');
      log('Done.');
    } catch(e){ log('Program failed: ' + e); }
  };

  if (!('serial' in navigator)) {
    log('Use Chrome/Edge on desktop (Web Serial required).');
    document.getElementById('connect').disabled = true;
  }
</script>
