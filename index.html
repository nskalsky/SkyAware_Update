<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ESP32 Web Flasher (factory + ota_1)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; max-width: 820px; margin: 24px auto; line-height: 1.35; }
    fieldset { border: 1px solid #ddd; border-radius: 10px; padding: 16px; margin: 16px 0; }
    legend { padding: 0 6px; font-weight: 700; }
    label { display: block; margin: 8px 0 4px; }
    input[type="text"] { width: 200px; }
    .row { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
    .btn { padding: 10px 14px; border-radius: 10px; border: 1px solid #ccc; background: #f6f6f6; cursor: pointer; }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    #log { background: #0c0f14; color: #e6e6e6; padding: 12px; height: 240px; overflow: auto; border-radius: 8px; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; }
    .hint { color: #666; font-size: 0.95em; }
  </style>
</head>
<body>
  <h1>ESP32 Web Flasher</h1>
  <p class="hint">
    Use Chrome/Edge on HTTPS or <code>http://localhost</code>. Click <b>Connect</b>, select the serial port, pick your binaries, set offsets, then <b>Flash</b>.
    (Safari is not supported.) :contentReference[oaicite:1]{index=1}
  </p>

  <div class="row">
    <label>Baud:
      <select id="baud">
        <option>921600</option>
        <option>460800</option>
        <option selected>115200</option>
      </select>
    </label>
    <button id="connect" class="btn">Connect</button>
    <button id="disconnect" class="btn" disabled>Disconnect</button>
    <span id="status">Not connected</span>
  </div>

  <fieldset>
    <legend>Images</legend>

    <div class="row">
      <div>
        <label>factory.bin (app @ <code>0x10000</code> typical)</label>
        <input type="file" id="factory" accept=".bin" />
      </div>
      <div>
        <label>Address (hex)</label>
        <input type="text" id="addrFactory" value="0x10000" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>ota_1.bin (partition-aligned, e.g. <code>0x210000</code>)*</label>
        <input type="file" id="ota1" accept=".bin" />
      </div>
      <div>
        <label>Address (hex)</label>
        <input type="text" id="addrOta1" value="0x210000" />
      </div>
    </div>

    <p class="hint">* Replace addresses with <b>your</b> partition layout. Common app @ <code>0x10000</code>; OTA slots on 64-KB boundaries (check your CSV). </p>
  </fieldset>

  <div class="row">
    <button id="flash" class="btn" disabled>Flash</button>
    <button id="erase" class="btn" disabled>Erase Flash</button>
    <button id="chipInfo" class="btn" disabled>Chip Info</button>
  </div>

  <h3>Log</h3>
  <pre id="log"></pre>

  <!-- Use the official bundle documented by Espressif -->
  <script src="https://unpkg.com/esptool-js@0.5.6/bundle.js"></script>
  <script>
    // Globals from the UMD bundle:
    // window.ESPLoader, window.TransportWebSerial
    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('status');
    const btnConnect = document.getElementById('connect');
    const btnDisconnect = document.getElementById('disconnect');
    const btnFlash = document.getElementById('flash');
    const btnErase = document.getElementById('erase');
    const btnInfo = document.getElementById('chipInfo');
    const baudEl = document.getElementById('baud');

    const factoryFile = document.getElementById('factory');
    const ota1File = document.getElementById('ota1');
    const addrFactoryEl = document.getElementById('addrFactory');
    const addrOta1El = document.getElementById('addrOta1');

    let transport = null;
    let loader = null;

    const term = {
      clean(){ logEl.textContent=''; },
      writeLine(d){ logEl.textContent += d + "\n"; logEl.scrollTop = logEl.scrollHeight; },
      write(d){ logEl.textContent += d; logEl.scrollTop = logEl.scrollHeight; }
    };

    function setConnected(yes){
      btnDisconnect.disabled = !yes;
      btnFlash.disabled = !yes;
      btnErase.disabled = !yes;
      btnInfo.disabled = !yes;
      btnConnect.disabled = yes;
      statusEl.textContent = yes ? 'Connected' : 'Not connected';
    }

    function hexToInt(str){
      try {
        const s = str.trim().toLowerCase();
        return s.startsWith('0x') ? parseInt(s, 16) : parseInt(s, 16);
      } catch { return NaN; }
    }

    async function getFileData(fileInput){
      if(!fileInput.files || !fileInput.files[0]) return null;
      const buf = await fileInput.files[0].arrayBuffer();
      return new Uint8Array(buf);
    }

    async function connect() {
      if (!('serial' in navigator)) {
        alert('Web Serial not supported. Use Chrome/Edge on HTTPS or localhost.');
        return;
      }
      try {
        transport = new TransportWebSerial();
        await transport.connect(); // prompts port chooser
        const baud = parseInt(baudEl.value, 10);
        loader = new ESPLoader({ transport, baudrate: baud, terminal: term });
        term.clean();
        term.writeLine('Connecting...');
        await loader.connect();
        await loader.sync();
        await loader.flush();
        setConnected(true);
        term.writeLine('Connected.');
      } catch (e) {
        term.writeLine('Connect error: ' + e);
        await disconnect();
      }
    }

    async function disconnect(){
      try { if (transport) await transport.disconnect(); } catch {}
      transport = null; loader = null;
      setConnected(false);
    }

    async function eraseFlash(){
      try {
        term.writeLine('Erasing flash (this can take a while)...');
        await loader.eraseFlash();
        term.writeLine('Erase completed.');
      } catch(e){
        term.writeLine('Erase error: ' + e);
      }
    }

    async function chipInfo(){
      try {
        const chip = await loader.chipName();
        const mac = await loader.readMac();
        term.writeLine(`Chip: ${chip}`);
        term.writeLine(`MAC: ${mac}`);
      } catch(e){
        term.writeLine('Chip info error: ' + e);
      }
    }

    async function flash() {
      try {
        const fApp = await getFileData(factoryFile);
        const oApp = await getFileData(ota1File);
        if(!fApp && !oApp){
          alert('Select at least one binary.');
          return;
        }

        const jobs = [];
        if (fApp) {
          const addrF = hexToInt(addrFactoryEl.value);
          if (!Number.isInteger(addrF)) throw new Error('Invalid factory address');
          jobs.push({ data: fApp, address: addrF });
        }
        if (oApp) {
          const addrO = hexToInt(addrOta1El.value);
          if (!Number.isInteger(addrO)) throw new Error('Invalid ota_1 address');
          jobs.push({ data: oApp, address: addrO });
        }

        term.writeLine('Entering bootloader…');
        await loader.flashIdfData(jobs, (pct) => {
          term.writeLine(`Progress: ${pct.toFixed(1)}%`);
        });
        term.writeLine('Flashing done. Hard resetting…');
        await loader.hardReset();
      } catch(e){
        term.writeLine('Flash error: ' + e);
      }
    }

    btnConnect.addEventListener('click', connect);
    btnDisconnect.addEventListener('click', disconnect);
    btnErase.addEventListener('click', eraseFlash);
    btnInfo.addEventListener('click', chipInfo);
    document.getElementById('flash').addEventListener('click', flash);
  </script>
</body>
</html>
