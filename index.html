<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>ESP Flasher â€“ DIAG</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 20px; }
    button { padding: 8px 12px; }
    #log { white-space: pre-wrap; background:#111; color:#0f0; padding:10px; border-radius:6px; min-height:200px; max-height:50vh; overflow:auto; margin-top:12px; }
    .warn { color:#b45309; }
    .ok { color:#065f46; }
  </style>
</head>
<body>
  <h1>ESP Flasher â€“ DIAG</h1>

  <p>
    Secure context: <strong id="secure"></strong> Â·
    Browser: <strong id="browser"></strong> Â·
    <code>navigator.serial</code>: <strong id="serial"></strong>
  </p>

  <button id="connect" disabled>ðŸ”Œ Connect</button>
  <input type="file" id="fw" accept=".bin" />
  <button id="flash" disabled>âš¡ Flash both</button>

  <div id="log"></div>

  <script type="module">
    const $ = (s)=>document.querySelector(s);
    const logEl = $('#log');
    const log = (m)=>{ logEl.textContent += m + "\\n"; logEl.scrollTop = logEl.scrollHeight; };

    // Basic environment checks
    $('#secure').textContent = String(window.isSecureContext);
    $('#browser').textContent = navigator.userAgent;
    $('#serial').textContent = ('serial' in navigator) ? 'available' : 'MISSING';

    // If Web Serial missing, explain and bail early
    if (!('serial' in navigator)) {
      log('âŒ Web Serial API not available.');
      log('Use Chrome or Edge on desktop. Safari/Firefox/iOS are not supported.');
      log('On Chrome: chrome://settings/content/serialPorts (ensure Allowed for your site).');
    }

    // Try loading ESPLoader as an ES module
    let ESPLoader;
    try {
      ({ ESPLoader } = await import("https://unpkg.com/esptool-js@0.5.7/lib/index.js"));
      if (ESPLoader) log('âœ… ESPLoader module imported.');
      else log('âŒ ESPLoader import returned null/undefined.');
    } catch (e) {
      log('âŒ ESPLoader import failed: ' + e);
    }

    let port, loader, connected = false;

    async function connect() {
      log('Connect clicked.');
      if (!('serial' in navigator)) return log('Cannot connect: Web Serial not available.');
      if (!ESPLoader) return log('Cannot connect: ESPLoader not loaded.');

      try {
        port = await navigator.serial.requestPort();
        log('Port selected.');
        await port.open({ baudRate: 115200 });
        log('Port opened.');
        loader = new ESPLoader({ transport: { device: port }, baudrate: 115200, terminal: { write: (s)=>log(String(s)) }});
        log('Connecting to bootloaderâ€¦');
        await loader.connect('default_reset', 7, true);
        log('Connected. Chip: ' + (await loader.chipName()));
        await loader.runStub();
        try { await loader.changeBaud(921600); log('Baud -> 921600'); } catch(e) { log('Baud change failed: ' + e); }
        connected = true;
        $('#flash').disabled = false;
        log('âœ… Ready to flash.');
      } catch (e) {
        log('âŒ Connect failed: ' + e);
        log('Hints: Close Arduino/PlatformIO/serial terminals; use HTTPS; try a different USB cable/port.');
      }
    }

    // Enable/disable buttons only after we know the environment
    $('#connect').disabled = !(ESPLoader && ('serial' in navigator) && window.isSecureContext);
    if ($('#connect').disabled) {
      log('â„¹ï¸ Connect disabled because: '
        + (!window.isSecureContext ? '[insecure origin] ' : '')
        + (!('serial' in navigator) ? '[no Web Serial] ' : '')
        + (!ESPLoader ? '[module failed]' : '')
      );
    }

    $('#connect').addEventListener('click', connect);
    $('#flash').addEventListener('click', ()=>log('Flash not wired in this DIAG page. If connect works, swap back to your main page.'));
  </script>
</body>
</html>

</html>

